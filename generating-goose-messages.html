<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Keith's Blog</title>
	<meta name="description" content="">
	<meta name="author" content="Keith Gray">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="http://idahogray.github.io/blog/theme/html5.js"></script>
	<![endif]-->

	<!-- Styles -->
	<link href="http://idahogray.github.io/blog/theme/bootstrap.min.css" rel="stylesheet">
	<link href="http://idahogray.github.io/blog/theme/local.css" rel="stylesheet">
	<link href="http://idahogray.github.io/blog/theme/pygments.css" rel="stylesheet">

	<!-- Feeds -->
	<link href="http://idahogray.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Keith's Blog Atom Feed" />



        <link href="feeds/rss.xml" rel="alternate" title="Keith's Blog" type="application/rss+xml">

<script type="text/javascript">
	var disqus_identifier = "generating-goose-messages.html";
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'https://keithgraysblog.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
</head>
<body>
<a href="http://github.com/idahogray/"><img style="position: absolute; top: 39px; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub" /></a>
	<div class="topbar">
	  <div class="topbar-inner">
		<div class="container-fluid">
		  <a class="brand" href="http://idahogray.github.io/blog/">Keith's Blog</a>
			<ul class="nav">
					<li ><a href="http://idahogray.github.io/blog/category/kids.html">kids</a></li>
					<li ><a href="http://idahogray.github.io/blog/category/personal.html">personal</a></li>
					<li class="active"><a href="http://idahogray.github.io/blog/category/work.html">work</a></li>
			</ul>
			<p class="pull-right"><a href="http://idahogray.github.io/blog/archives.html">[archives]</a> <a href="http://idahogray.github.io/blog/tags.html">[tags]</a></p>
		</div>
	  </div>
	</div>

	<div class="container-fluid">
	  <div class="sidebar">
		<div class="well">
			<h3>Blogroll</h3>
			<ul>
				<li><a href="http://www.powereng.com">POWER Engineers</a></li>
				<li><a href="http://python.org">Python.org</a></li>
				<li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
				<li><a href="http://jinja.pocoo.org">Jinja2</a></li>
			</ul>
			<div class="social">
			<h3>Social</h3>
			<ul>
				<li><a href="http://twitter.com/idahogray">twitter</a></li>
				<li><a href="http://github.com/idahogray">github</a></li>
			</ul>
			</div>
		</div>
	  </div>
	  <div class="content">
	<div class='article'>
		<div class="page-header"><h1>Generating GOOSE Messages</h1></div>
		<div class="well small">Permalink: <a class="more" href="http://idahogray.github.io/blog/generating-goose-messages.html">2018-12-19 08:00:00-06:00</a>
by <a class="url fn" href="http://idahogray.github.io/blog/author/keith-gray.html">Keith Gray </a>
 in <a href="http://idahogray.github.io/blog/category/work.html">work</a>
tags: <a href="http://idahogray.github.io/blog/tag/goose.html">GOOSE</a> <a href="http://idahogray.github.io/blog/tag/python.html">python</a> <a href="http://idahogray.github.io/blog/tag/iec-61850.html">IEC 61850</a> </div>
		<div><p>This is a continuation of a previous <a class="reference external" href="http://idahogray.github.io/blog/2016-09-24.html">post</a>.
It that previous post, an implementation of the GOOSE <abbr title="Abstract Syntax Notation One">ASN.1</abbr> encoder.
I have since update that repository to include an example showing how to created
a GOOSE message using that <abbr title="Abstract Syntax Notation One">ASN.1</abbr> definition and the <a class="reference external" href="http://www.secdev.org/projects/scapy/">scapy</a> library. The example
is explained below.</p>
<p>First, the IECGoosePDU ASN.1 type is created.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyasn1.type</span> <span class="kn">import</span> <span class="n">tag</span>

<span class="kn">from</span> <span class="nn">goose_pdu</span> <span class="kn">import</span> <span class="n">IECGoosePDU</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">IECGoosePDU</span><span class="p">()</span><span class="o">.</span><span class="n">subtype</span><span class="p">(</span>
    <span class="n">implicitTag</span><span class="o">=</span><span class="n">tag</span><span class="o">.</span><span class="n">Tag</span><span class="p">(</span>
        <span class="n">tag</span><span class="o">.</span><span class="n">tagClassApplication</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">.</span><span class="n">tagFormatConstructed</span><span class="p">,</span>
        <span class="mi">1</span>
     <span class="p">)</span>
<span class="p">)</span>
</pre></div>
<p>Next, the static portion of the GOOSE message is created by setting each of the
fields to an appropriate value. gocbRef, datSet, and goID are set to strings.
timeAllowedtoLive, stNum, sqNum, confRev, and numDatSetEntries are set to integers.
t is set to a valid timestamp. test and ndsCom are boolean values.</p>
<div class="highlight"><pre><span></span><span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;gocbRef&#39;</span><span class="p">,</span> <span class="s1">&#39;PDC-2+11+700G_G1CFG/LLNO$GO$GooseDset_BF&#39;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;timeAllowedtoLive&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;datSet&#39;</span><span class="p">,</span> <span class="s1">&#39;PDC02_11_700G_G1CFG/LLN0$Dset_BF&#39;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;goID, &#39;</span><span class="mi">11</span><span class="n">_700G_G1_Dset_BF</span><span class="s1">&#39;)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x55\x15\x1b\x9b\x69\x37\x40\x92</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;stNum&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;sqNum&#39;</span><span class="p">,</span> <span class="mi">1757</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;confRev&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;ndsCom&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;numDatSetEntries&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
<p>The dynamic data is then added. In this example, 2 boolean values are added to the message,
including their associated quality and timestamp. Each of the 6 data items are created and
added to the 'allData' field. The 'allData' field is then added to the GOOSE message.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">goose_pdu</span> <span class="kn">import</span> <span class="n">AllData</span>
<span class="kn">from</span> <span class="nn">goose_pdu</span> <span class="kn">import</span> <span class="n">Data</span><span class="p">()</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">AllData</span><span class="p">()</span><span class="o">.</span><span class="n">subtype</span><span class="p">(</span>
    <span class="n">implicitTag</span><span class="o">=</span><span class="n">tag</span><span class="o">.</span><span class="n">Tag</span><span class="p">(</span>
        <span class="n">tag</span><span class="o">.</span><span class="n">tagClassContext</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">.</span><span class="n">tagFormatConstructed</span><span class="p">,</span>
        <span class="mi">11</span>
     <span class="p">)</span>
<span class="p">)</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<span class="n">d1</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<span class="n">d2</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;bit-string&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;0000000000000&#39;B&quot;</span><span class="p">)</span>
<span class="n">d3</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<span class="n">d3</span><span class="o">.</span><span class="n">setComponentByName</span><span class="s1">&#39;utc-time&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x55\x15\x14\xc0\xc8\xf5\xc0\x92</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">d4</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<span class="n">d4</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">d5</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<span class="n">d5</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;bit-string&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;0000000000000&#39;B&quot;</span><span class="p">)</span>
<span class="n">d6</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<span class="n">d6</span><span class="o">.</span><span class="n">setComponentByName</span><span class="s1">&#39;utc-time&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x55\x15\x14\xaa\x3a\x9f\x80\x92</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setComponentByPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d1</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setComponentByPosition</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setComponentByPosition</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">d3</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setComponentByPosition</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">d4</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setComponentByPosition</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">d5</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setComponentByPosition</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">d6</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">setComponentByName</span><span class="p">(</span><span class="s1">&#39;addData&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
<p>The last step is to create the <a class="reference external" href="http://www.secdev.org/projects/scapy/">scapy</a> packet. The Ethernet frame is created with
the GOOSE multicast destination address. VLAN information is added to the packet placing
the message in VLAN 10 with priority 6, and GOOSE as the type. The GOOSE static data fields
are then added followed by the dynamic ASN.1 encoded fields.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyasn1.codec.ber</span> <span class="kn">import</span> <span class="n">encoder</span>
<span class="kn">from</span> <span class="nn">scapy.layers.l2</span> <span class="kn">import</span> <span class="n">Ether</span>
<span class="kn">from</span> <span class="nn">scapy.layers.l2</span> <span class="kn">import</span> <span class="n">Dot1Q</span>
<span class="kn">from</span> <span class="nn">scapy.utils</span> <span class="kn">import</span> <span class="n">hexdump</span>

<span class="kn">from</span> <span class="nn">goose</span> <span class="kn">import</span> <span class="n">GOOSE</span>

<span class="n">hexdump</span><span class="p">(</span>
    <span class="n">Ether</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s1">&#39;01:0c:cd:01:00:14&#39;</span><span class="p">)</span> <span class="o">/</span>
    <span class="n">Dot1Q</span><span class="p">(</span><span class="n">vlan</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mh">0x88b8</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span>
    <span class="n">GOOSE</span><span class="p">(</span><span class="n">appid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mh">0x00b1</span><span class="p">))</span> <span class="o">/</span>
    <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
<div class="section" id="next-steps">
<h2>Next Steps</h2>
<p>The next step in this experiment will be to use this GOOSE message in a network
packet created with <a class="reference external" href="http://www.secdev.org/projects/scapy/">scapy</a> and transmit it on a network interface using the scapy.sendp()
function.</p>
</div>
</div>
		<div>
			<h2>Comments</h2>
<div id="disqus_thread"></div>		<div>
	</div>
		<footer>
		  <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme based on <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>.</p>
		  <p>&copy; Keith Gray</p>
		</footer>
	  </div>

	</div>
</body>
</html>